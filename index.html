<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Faktura VAT - PDF profesjonalny</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body {font-family: Arial, sans-serif; max-width:800px; margin:40px auto; padding:20px; border:1px solid #ccc; border-radius:12px;}
input {margin:5px 0; padding:8px; width: calc(100% - 20px);}
button {margin:10px 5px; padding:10px 15px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer;}
button:hover {background:#0056b3;}
#products {margin-top:15px;}
.product {margin:5px 0; display:flex; justify-content:space-between; align-items:center;}
.remove-btn {background:red; padding:5px 10px; border-radius:4px; color:white; cursor:pointer;}
#invoice-preview {margin-top:30px; padding:20px; border:2px dashed #666; border-radius:8px; background:#f9f9f9;}
table {border-collapse: collapse; width: 100%; margin-bottom:15px;}
table, th, td {border: 1px solid black; padding: 4px; text-align: left; font-size:10pt;}
ul#nipList {border:1px solid #ccc; max-height:100px; overflow-y:auto; margin:0; padding:0; list-style:none;}
ul#nipList li {padding:5px; cursor:pointer;}
ul#nipList li:hover {background:#eee;}
/* Modal */
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);}
.modal-content {background:#fff; margin:10% auto; padding:20px; border-radius:8px; width:600px; max-height:70vh; overflow-y:auto;}
.modal-content h3 {margin-top:0;}
.close-btn {float:right; cursor:pointer; font-weight:bold; font-size:18px; color:red;}
.client-item {border-bottom:1px solid #ddd; padding:8px 0;}
.client-actions button {margin-left:5px; font-size:12px; padding:5px 8px;}
</style>
</head>
<body>

<h1>Generator faktury VAT</h1>

<!-- Dane sprzedawcy -->
<h2>Dane sprzedawcy</h2>
<table>
  <tr><td>Nazwa firmy:</td><td>BeeElectronic</td></tr>
  <tr><td>Adres:</td><td>Warszawa, ul. Przykladowa 1</td></tr>
  <tr><td>NIP:</td><td>50231458</td></tr>
</table>

<h2 style="display:flex;justify-content:space-between;align-items:center;">
  Dane nabywcy
  <button id="manageClientsBtn" type="button">Zarzadzaj klientami</button>
</h2>
<input id="clientName" type="text" placeholder="Imie i nazwisko">
<input id="clientAddress" type="text" placeholder="Adres">
<input id="clientNIP" type="text" placeholder="NIP">
<ul id="nipList"></ul>

<h2>Produkty</h2>
<div>
  <input id="name" type="text" placeholder="Nazwa produktu">
  <input id="price" type="number" placeholder="Cena netto (PLN)">
  <input id="quantity" type="number" placeholder="Ilosc" value="1">
  <button id="addBtn" type="button" onclick="addProduct()">Dodaj produkt</button>
</div>

<div id="products"></div>

<h2>Razem netto: <span id="total">0</span> PLN</h2>

<button id="showBtn">Pokaz fakture</button>
<button id="downloadBtn">Pobierz PDF (oryginal + kopia)</button>

<div id="invoice-preview" style="display:none;"></div>

<!-- Modal klientow -->
<div id="clientsModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeClientsModal">&times;</span>
    <h3>Lista klientow</h3>
    <div id="clientsList"></div>
    <h4>Dodaj/Edytuj klienta</h4>
    <input id="modalClientNIP" type="text" placeholder="NIP">
    <input id="modalClientName" type="text" placeholder="Imie i nazwisko">
    <input id="modalClientAddress" type="text" placeholder="Adres">
    <button id="saveClientBtn">Zapisz klienta</button>
  </div>
</div>

<script>
let invoice = {products: []};
let editingNIP = null;

function replacePolishChars(str){
  const map={"ą":"a","ć":"c","ę":"e","ł":"l","ń":"n","ó":"o","ś":"s","ż":"z","ź":"z",
             "Ą":"A","Ć":"C","Ę":"E","Ł":"L","Ń":"N","Ó":"O","Ś":"S","Ż":"Z","Ź":"Z"};
  return str.replace(/[ąćęłńóśżźĄĆĘŁŃÓŚŻŹ]/g,m=>map[m]||m);
}

function getNextInvoiceNumber(){
  const year=new Date().getFullYear();
  const key=`FV-${year}-counter`;
  let counter=parseInt(localStorage.getItem(key))||1;
  localStorage.setItem(key,counter+1);
  return `FV/${year}/${String(counter).padStart(3,'0')}`;
}

window.addProduct = function(){
  const name=document.getElementById("name").value;
  const price=parseFloat(document.getElementById("price").value);
  const quantity=parseInt(document.getElementById("quantity").value);
  if(!name || isNaN(price) || isNaN(quantity) || quantity <= 0){
    alert("Podaj poprawne dane produktu!");
    return;
  }
  invoice.products.push({name:name, price:price, quantity:quantity});
  renderProducts();
  document.getElementById("name").value="";
  document.getElementById("price").value="";
  document.getElementById("quantity").value="1";
}

function removeProduct(index){
  invoice.products.splice(index,1);
  renderProducts();
}

function renderProducts(){
  const productsDiv = document.getElementById("products");
  productsDiv.innerHTML = "";
  let total = 0;
  invoice.products.forEach((p,i)=>{
    const div=document.createElement("div");
    div.classList.add("product");
    const lineTotal = p.price * p.quantity;
    total += lineTotal;
    div.innerHTML=`<span>${p.name} - ${p.price.toFixed(2)} PLN x ${p.quantity} = ${lineTotal.toFixed(2)} PLN</span>
                   <button class="remove-btn" onclick="removeProduct(${i})">Usun</button>`;
    productsDiv.appendChild(div);
  });
  document.getElementById("total").textContent = total.toFixed(2);
}

function splitText(str, maxLength){
  if(str.length <= maxLength) return [str];
  const lines = [];
  let current = str;
  while(current.length > maxLength){
    let splitAt = current.lastIndexOf(' ', maxLength);
    if(splitAt === -1) splitAt = maxLength;
    lines.push(current.substring(0, splitAt));
    current = current.substring(splitAt).trim();
  }
  if(current.length>0) lines.push(current);
  return lines;
}

function saveClient(){
  const clientName = document.getElementById("clientName").value;
  const clientAddress = document.getElementById("clientAddress").value;
  const clientNIP = document.getElementById("clientNIP").value;
  if(clientName && clientAddress && clientNIP){
    let clients = JSON.parse(localStorage.getItem("clients") || "{}");
    clients[clientNIP] = {name: clientName, address: clientAddress};
    localStorage.setItem("clients", JSON.stringify(clients));
  }
}

function searchClient(){
  const clientNIP = document.getElementById("clientNIP").value;
  let clients = JSON.parse(localStorage.getItem("clients") || "{}");
  const list = document.getElementById("nipList");
  list.innerHTML = "";
  if(!clientNIP) return;
  for(let nip in clients){
    if(nip.startsWith(clientNIP)){
      const li = document.createElement("li");
      li.textContent = `${nip} - ${clients[nip].name}`;
      li.onclick = ()=>{
        document.getElementById("clientNIP").value = nip;
        document.getElementById("clientName").value = clients[nip].name;
        document.getElementById("clientAddress").value = clients[nip].address;
        list.innerHTML="";
      };
      list.appendChild(li);
    }
  }
  if(clients[clientNIP]){
    document.getElementById("clientName").value = clients[clientNIP].name;
    document.getElementById("clientAddress").value = clients[clientNIP].address;
  }
}

function showInvoice(){
  const invoiceNumber = getNextInvoiceNumber();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt",format:"a4"});
  generatePDF(invoiceNumber,"ORYGINAL",doc);
  const previewDiv = document.getElementById("invoice-preview");
  previewDiv.style.display="block";
  previewDiv.innerHTML = `<iframe style="width:100%;height:600px;" src="${doc.output('datauristring')}"></iframe>`;
}

function generatePDF(invoiceNumber,type,doc){
  const clientName = replacePolishChars(document.getElementById("clientName").value);
  const clientAddress = replacePolishChars(document.getElementById("clientAddress").value);
  const clientNIP = replacePolishChars(document.getElementById("clientNIP").value);
  const today = replacePolishChars(new Date().toLocaleDateString());
  const paymentDateObj = new Date();
  paymentDateObj.setDate(new Date().getDate() + 14);
  const paymentDate = replacePolishChars(paymentDateObj.toLocaleDateString());

  const colWidths = [30, 130, 80, 50, 70, 60, 60];
  const headers = ["Lp","Nazwa produktu","Cena jedn. netto","Ilosc","Wartosc netto","VAT 23%","Brutto"];

  let y = 40;
  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text(`Faktura VAT - ${type}`, 300, y, {align:"center"});

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);

  y+=20;
  doc.text("Sprzedawca:",40,y);
  doc.text("BeeElectronic",120,y);
  y+=12; doc.text("Adres: Warszawa, ul. Przykladowa 1",120,y);
  y+=12; doc.text("NIP: 50231458",120,y);

  doc.rect(380,60,180,50);
  doc.text(`Nr faktury: ${invoiceNumber}`,390,75);
  doc.text(`Data sprzedazy: ${today}`,390,90);
  doc.text(`Termin platnosci: ${paymentDate}`,390,105);

  y+=40;
  doc.text("Nabywca:",40,y);
  doc.text(`Nazwa: ${clientName}`,120,y);
  y+=12; doc.text(`Adres: ${clientAddress}`,120,y);
  y+=12; doc.text(`NIP: ${clientNIP}`,120,y);

  let rowY = y+30;
  doc.setFont("helvetica","bold");
  headers.forEach((h,i)=>{
    doc.rect(40 + colWidths.slice(0,i).reduce((a,b)=>a+b,0), rowY, colWidths[i], 20);
    doc.text(h, 42 + colWidths.slice(0,i).reduce((a,b)=>a+b,0), rowY+14);
  });
  doc.setFont("helvetica","normal");
  rowY += 20;

  let totalNet = 0;
  invoice.products.forEach((p,i)=>{
    if(rowY > 700){ 
      doc.addPage();
      rowY = 40;
    }
    let nameLines = splitText(replacePolishChars(p.name), 20);
    const net = p.price*p.quantity;
    const vat = net*0.23;
    const gross = net*1.23;
    totalNet += net;
    const rowHeight = 20*nameLines.length;

    if(i % 2 === 1){
      doc.setFillColor(230);
      doc.rect(40,rowY,colWidths.reduce((a,b)=>a+b,0),rowHeight,'F');
    }

    let x=40;
    const rowValues = [`${i+1}`, nameLines[0], p.price.toFixed(2), p.quantity.toString(), net.toFixed(2), vat.toFixed(2), gross.toFixed(2)];
    rowValues.forEach((v,j)=>{
      doc.rect(x,rowY,colWidths[j],rowHeight);
      doc.text(v,x+2,rowY+14);
      x+=colWidths[j];
    });
    if(nameLines.length>1){
      doc.text(nameLines[1], 40+colWidths[0]+2, rowY+28);
    }
    rowY += rowHeight;
  });

  const totalVAT = totalNet*0.23;
  const totalGross = totalNet*1.23;
  rowY += 10;
  doc.text(`Razem netto: ${totalNet.toFixed(2)} PLN`,40,rowY);
  doc.text(`VAT 23%: ${totalVAT.toFixed(2)} PLN`,40,rowY+12);
  doc.text(`Brutto: ${totalGross.toFixed(2)} PLN`,40,rowY+24);

  rowY += 40;
  doc.text("Podpis osoby upowaznionej do wystawienia faktury:",40,rowY);
  doc.text("Podpis osoby przyjmujacej fakture:",320,rowY);
  doc.rect(40,rowY+10,180,50); 
  doc.rect(320,rowY+10,180,50);

  rowY+=70;
  doc.rect(40,rowY,180,50);
  doc.setFontSize(8);
  doc.text("Pieczatka sprzedawcy", 45,rowY+45);
  doc.setFontSize(10);
}

document.getElementById("downloadBtn").addEventListener("click", ()=>{
  const invoiceNumber = getNextInvoiceNumber();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt",format:"a4"});
  generatePDF(invoiceNumber,"ORYGINAL",doc);
  doc.addPage();
  generatePDF(invoiceNumber,"KOPIA",doc);
  saveClient();
  doc.save(`Faktura_${invoiceNumber}.pdf`);
  doc.autoPrint();
  window.open(doc.output('bloburl'), '_blank');
});
document.getElementById("showBtn").addEventListener("click", showInvoice);
document.getElementById("clientNIP").addEventListener("input", searchClient);

/* Modal obsluga */
const modal=document.getElementById("clientsModal");
document.getElementById("manageClientsBtn").onclick=()=>{renderClientsList();modal.style.display="block";}
document.getElementById("closeClientsModal").onclick=()=>{modal.style.display="none";editingNIP=null;}
window.onclick=(e)=>{if(e.target==modal){modal.style.display="none";editingNIP=null;}}

function renderClientsList(){
  let clients = JSON.parse(localStorage.getItem("clients") || "{}");
  const container=document.getElementById("clientsList");
  container.innerHTML="";
  for(let nip in clients){
    const div=document.createElement("div");
    div.classList.add("client-item");
    div.innerHTML=`<b>${nip}</b> - ${clients[nip].name}, ${clients[nip].address}
      <span class="client-actions">
        <button onclick="editClient('${nip}')">Edytuj</button>
        <button onclick="deleteClient('${nip}')">Usun</button>
      </span>`;
    container.appendChild(div);
  }
}

function editClient(nip){
  let clients = JSON.parse(localStorage.getItem("clients") || "{}");
  document.getElementById("modalClientNIP").value = nip;
  document.getElementById("modalClientName").value = clients[nip].name;
  document.getElementById("modalClientAddress").value = clients[nip].address;
  editingNIP = nip;
}

function deleteClient(nip){
  let clients = JSON.parse(localStorage.getItem("clients") || "{}");
  delete clients[nip];
  localStorage.setItem("clients", JSON.stringify(clients));
  renderClientsList();
}

document.getElementById("saveClientBtn").onclick=()=>{
  let clients = JSON.parse(localStorage.getItem("clients") || "{}");
  const nip=document.getElementById("modalClientNIP").value;
  const name=document.getElementById("modalClientName").value;
  const address=document.getElementById("modalClientAddress").value;
  if(nip && name && address){
    clients[nip]={name,address};
    localStorage.setItem("clients", JSON.stringify(clients));
    renderClientsList();
    document.getElementById("modalClientNIP").value="";
    document.getElementById("modalClientName").value="";
    document.getElementById("modalClientAddress").value="";
    editingNIP=null;
  }
}
</script>

</body>
</html>

